@model WebApplication5.Models.Service
@{
    ViewData["Title"] = Model.Title;
    var canView = (ViewBag.CanViewContact as bool?) ?? false;
    var hasRequested = (ViewBag.HasRequested as bool?) ?? false;
    var currentRequestId = (ViewBag.CurrentRequestId as int?) ?? 0;
}

<div class="card">
    <div class="card-body">
        <h3>@Model.Title</h3>
        <h5 class="text-muted">@Model.Price @Model.Currency</h5>
        <p>@Model.Description</p>
        <p><strong>Ubicación:</strong> @Model.Location</p>
        <p><strong>Proveedor:</strong> @Model.Owner?.FullName</p>

        @if (canView)
        {
            <div class="mt-3 p-3 border rounded bg-light">
                <h6>Contacto del proveedor</h6>
                <p class="mb-1"><strong>Email:</strong> <a href="mailto:@Model.Owner?.Email">@Model.Owner?.Email</a></p>
                @if (!string.IsNullOrWhiteSpace(Model.Owner?.PhoneNumberPublic))
                {
                    var phone = Model.Owner.PhoneNumberPublic.Replace("+", "").Replace(" ", "");
                    <p class="mb-1"><strong>Teléfono:</strong> <a href="tel:@Model.Owner?.PhoneNumberPublic">@Model.Owner?.PhoneNumberPublic</a> <a class="btn btn-sm btn-success ms-2" target="_blank" href="https://wa.me/@phone">WhatsApp</a></p>
                }
            </div>
        }
        else
        {
            <div class="alert alert-info">
                El correo y teléfono del proveedor se muestran solamente al realizar una solicitud por este servicio. Haz clic en "Solicitar" para que los datos de contacto se revelen.
            </div>
        }

        @if (User?.Identity?.IsAuthenticated ?? false)
        {
            <div class="mt-3">
                @if (hasRequested)
                {
                    <form method="post" asp-controller="Service" asp-action="CancelRequest" class="d-inline">
                        <input type="hidden" name="requestId" value="@currentRequestId" />
                        <button type="submit" class="btn btn-danger">Cancelar solicitud</button>
                    </form>
                }
                else
                {
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#requestModal">Solicitar</button>
                }

                @* If current user is owner show toggle publish *@
                @{
                    var userId = Context.User?.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
                    if (userId == Model.OwnerId)
                    {
                        <form method="post" asp-controller="Service" asp-action="TogglePublish" class="d-inline ms-2">
                            <input type="hidden" name="id" value="@Model.Id" />
                            <button type="submit" class="btn btn-sm @(Model.IsPublished?"btn-warning":"btn-success")">@(Model.IsPublished?"Desactivar":"Publicar")</button>
                        </form>
                    }
                }
            </div>
        }
        else
        {
            <a asp-controller="Account" asp-action="Login" class="btn btn-primary">Inicia sesión para solicitar</a>
        }
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="requestModal" tabindex="-1" aria-labelledby="requestModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" asp-controller="Service" asp-action="RequestService">
      <div class="modal-header">
        <h5 class="modal-title" id="requestModalLabel">Solicitar servicio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
            <input type="hidden" name="ServiceId" value="@Model.Id" />
            <div class="mb-3">
                <label class="form-label">Mensaje</label>
                <textarea name="Message" class="form-control" rows="4" required></textarea>
            </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="submit" class="btn btn-primary">Enviar solicitud</button>
      </div>
      </form>
    </div>
  </div>
</div>
